
有道云笔记自开发至今已经3年多，正式上线也有两年半，目前用户已经突破两千万。随着用户的增长，数据的增多，访问压力的增大，我们的服务也一直在接受考验。现在反过来回顾我们的开发历程，会有一些非常有价值的心得体会。现在就从数据结构设计、云端框架结构设计、代码升级重构三个方面展开说一下。

数据结构设计
------------
数据结构设计是云端架构设计的第一要务。要做一个云端服务，最初要考虑的不应该是怎么去设计代码，怎么去弄一个代码框架出来，而是应该把数据结构给设计好。对于数据结构设计，需要考虑功能需求和性能需求两个方面。
#### 从功能需求的角度
所谓功能需求，是一个将服务或者功能抽象化的过程，设计出一组不同的数据类型，互相配合可以实现功能逻辑。就拿有道云笔记而言，为了实现一个带多级笔记本、增量同步、支持标签、可插入附件等等功能的一个云端服务。我们的数据结构有目录条目、笔记元数据信息、文件数据三种主要数据类型。为了实现文件diff，又将文件数据切块存放，衍生出了文件chunk类型。
#### 从性能需求的角度
从性能需求的角度，数据结构设计又可以分为两个要点。（1）存储服务的选择。当设计好的数据结构满足了功能需求之后，要考虑什么样的数据该使用什么样的存储方式，数据库该用mysql、HBase还是mongodb，文件系统选择HDFS还是TFS合适？不同的存储服务都有其最合适的使用场景，因此需要结合数据结构的访问需求去选择最合适存储服务。（2）优化数据结构设计。最常访问数据类型，比如笔记的目录，要尽可能的小，可以比较轻易的放到内存cache里面，从而防止大量请求落到后端存储服务上，给磁盘和IO造成压力；而大数据，比如几M甚至上G的文件，访问频度要尽可能的小，并且要在磁盘上尽可能的连续存放，请求时也是流式读取，从而避免读取时不断的做磁盘寻道；而介于两者之间的数据，往往访问频度比较大，放到内存又不能完全放得下，需要做LRU Cache，此时可以考虑使用SSD做此类数据的cache，也许会有不错的效果。

服务框架设计
------------
前面讲完数据结构的设计，再介绍一下服务框架的设计。在做服务框架设计之前，首先要阐述的一个观点就是，代码、框架都是为数据结构服务的；好的服务框架，能够更好的去表达前述的数据结构，更鲁棒的存取和处理数据，更高效的完成数据业务逻辑，为客户端提供更易用的数据接口。
自下而上介绍服务框架，首先是有道自有的底层云平台，提供分布式数据库、文件系统等服务。通过数据冗余、数据加密等策略保证数据的可靠性和安全性。这里不做太多的介绍。接下来，我们主要介绍一下在云平台之上的存储逻辑模块，分布式RPC中间件，以及在中间件之上是API接口模块。
#### 存储逻辑模块
存储逻辑模块主要实现了数据结构设计章节中定义的各种数据结构，相关的存取逻辑，以及与云平台的的接口模块。存储逻辑模块是无状态的，可以非常方便的水平扩展，从而实现了服务的可扩展性。按照笔记的需求，数据存取有原子性、一致性等需求，需要有事务的支持；而在底层云平台的分布式数据库上实现事务，逻辑复杂脆弱，性能不理想。因此，我们在存储逻辑模块上实现了事务的支持，原理是，通过zookeeper来管理存储逻辑模块，生成针对用户的一致性hash，从而将同一用户的请求分发到同一个存储逻辑模块上，以实现针对用户有效的内存锁。然后，基于版本号与预写标记，实现了数据的事务支持。而在这个过程中，用户请求的分发借助了我们的分布式RPC中间件。
#### 分布式RPC中间件
分布式RPC中间件主要实现了对服务模块的RPC服务封装，屏蔽服务模块的分布式细节，提供统一的RPC服务供上层调用。开发者可以自定义RPC调用的分发机制，如轮转调度，错误轮转重试，请求多发，基于zookeeper和一致性hash的用户请求分发机制等调度机制。分布式RPC中间件的存在，大大简化了分布式服务的设计与实现；开发者只需要定义好自己的服务和RPC调度机制，就可以实现一个可水平扩展的分布式RPC服务。且使用简单，使用者无须关注底层分布式细节。
#### API接口模块
因为有数据、认证、Push等一系列的API服务，不同的客户端针对数据视图有不同的需求，因此我们的API接口模块包括针对PC客户端的重量级API，以及针对web、Mobile的轻量级API，还有用户认证、OpenAPI、PushServer等一系列的API。因为分布式RPC中间件的帮助，各个API模块主要负责接口封装发布，且只需要通过分布式RPC中间件与存储逻辑模块交互，并无横向逻辑调用，所以逻辑简单，易于维护，开发变得敏捷迅速。

架构重构
------------
在这三年多的开发时间里，我们总共经历了两次比较大规模的重构工作。对于软件而言，局部代码、甚至是整体架构重构，都是不可避免的，甚至是不可或缺的。为什么会进行重构，我认为主要是以下两方面的原因：（1）随着需求更改、功能扩展、压力增大，原来的代码或者框架已经不能胜任它的工作；（2）之前的设计可能存在某些问题，随着开发进程的推进，这个问题的负面影响越来越严重，从而通过重构为之前的错误设计买单。我们两次重构，两个原因各占其一。
#### 框架升级
在云笔记最早的版本里面，没有分布式RPC中间件，从而也没有独立的存储逻辑模块，存储逻辑模块是一个公共的代码，从而API模块需要考虑分布式相关细节，处理用户数据一致性等问题。为此，我们实现了分布式同步锁，全局异步任务等模块间协调模块，保证数据的正确性。可随着用户量的增大，协调模块的压力越来越大，逻辑也越来越脆弱。从而促使了我们改进我们的设计，引入RPC中间件，将逻辑和API分层。一方面使得代码逻辑简单，层次清晰，鲁棒性好；另一方面，很大的提升了服务的承压能力。
#### 为设计错误买单
在前述数据结构设计的时候，我们提到将文件切块，实现文件diff的事情。而后来经过统计发现，文件切块diff带来的收益是极其微小的。但切块后的文件存在类bigtable的分布式数据库上，破坏了文件存储的整体性，使得上传下载文件时，都需要切块与拼接，从而导致性能的下降。直接瓶颈出现在数据上传时分布式数据库的写流量的放大，导致网络IO的压力。因此，我们重构了这块的代码，将文件整体存储在分布式文件系统上，取消了切块逻辑。这次重构虽然阐述起来简单，但是很大的精力被耗费在API兼容上：我们依然为旧版的客户端提供基于切块的API支持，使得它们依然可以使用云笔记服务。

结语
------------
本案例主要讲了三个方面的经验和心得：（1）数据结构设计是云端架构设计的第一要务；（2）服务框架设计服务于数据；（3）架构重构是不可避免的，甚至是不可或缺的。


